<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="initial-scale=1,user-scalable=no,maximum-scale=1,width=device-width">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#000000">
    <meta name="description" content="">
    <meta name="author" content="">
    <title>Test</title>
	<script type="text/javascript" src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
<script type="text/javascript" src="http://inaadress.maaamet.ee/inaadress/js/inaadress.min.js"></script>
<link rel="stylesheet" href="http://openlayers.org/en/v3.2.1/css/ol.css" type="text/css">
    <script src="http://openlayers.org/en/v3.2.1/build/ol.js" type="text/javascript"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.3.10/proj4.js"></script>
	<script type="text/javascript" src="ajax-cross-origin/jquery.ajax-cross-origin.min.js"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="assets/css/app.css">
    <link rel="apple-touch-icon" sizes="76x76" href="assets/img/favicon-76.png">
    <link rel="apple-touch-icon" sizes="120x120" href="assets/img/favicon-120.png">
    <link rel="apple-touch-icon" sizes="152x152" href="assets/img/favicon-152.png">
    <link rel="icon" sizes="196x196" href="assets/img/favicon-196.png">
    <link rel="icon" type="image/x-icon" href="assets/img/favicon.ico">
  </head>
  <body>
  <div  id="info" class="modal fade">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title">Info</h4>
      </div>
      <div class="modal-body" id="infoBody">
        <p></p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>
  
  
    <div class="navbar navbar-inverse navbar-fixed-top" role="navigation">
      <div class="container-fluid">
        <div class="navbar-header">
          <div class="navbar-icon-container">
            <a href="#" class="navbar-icon pull-right visible-xs" id="nav-btn"><i class="fa fa-bars fa-lg white"></i></a>
          </div>
          <a class="navbar-brand" href="#">Test</a>
        </div>
        <div class="navbar-collapse collapse">
		  <div id="search" style="padding-bottom: 20px"></div>
            <div class="form-group has-feedback">
            </div>
          
        </div>
      </div>
    </div>

    <div id="container">
    <div id=info></div>
    <div id="map" class="full-map"></div>
	<div id="location" class="marker"><span class="icon-arrow-up"></span></div>
    </div>
	
    <script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/typeahead.js/0.10.5/typeahead.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/handlebars.js/3.0.3/handlebars.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/list.js/1.1.1/list.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.5/leaflet.js"></script>
    <script src="https://api.tiles.mapbox.com/mapbox.js/plugins/leaflet-markercluster/v0.4.0/leaflet.markercluster.js"></script>
    <script src="https://api.tiles.mapbox.com/mapbox.js/plugins/leaflet-locatecontrol/v0.43.0/L.Control.Locate.min.js"></script>
    <script src="assets/leaflet-groupedlayercontrol/leaflet.groupedlayercontrol.js"></script>
    <script src="assets/js/app.js"></script>
	
	<script>
	var inAadress = new InAadress({"mode":"3","container":"search","nocss":false,"appartment":0});
document.addEventListener('addressSelected', function (e) {    
	if (typeof window.searchAdrVectorLayer === "object") {
            map.removeLayer(window.searchAdrVectorLayer);
        }
        var info = e.detail; 
		console.log(info)
		$(".navbar-collapse").collapse("toggle");
		
		
		if (info.length > 0) {
            // usually select first coordinate as it is most precise
            var x = info[0].x;
            x = parseFloat(x);
            var y = info[0].y;
            y = parseFloat(y);
            var address = info[0].aadress;
            var coordinates = [y, x];
            map.getView().setCenter(coordinates);
            map.getView().setZoom(11);
            inAadress.setAddress(address);
            inAadress.hideResult();
            var searchAdrFeature = new ol.Feature({
                geometry: new ol.geom.Point([y, x]),
                name: address
            });
            var iconStyle = new ol.style.Style({
                image: new ol.style.Icon(({
                    anchor: [1, 1],
                    opacity: 1,
                    src: 'assets/img/marker_34_green.png'
                }))
            });
            var searchAdrVectorSource = new ol.source.Vector({
            });
            window.searchAdrVectorSource = searchAdrVectorSource;
            var startSourceSize = searchAdrVectorSource.getFeatures().length;
            for (var i = 0, ii = startSourceSize; i < ii; i++) {
                searchAdrVectorSource.removeFeature(searchAdrVectorSource.getFeatures()[0])
            }
            searchAdrVectorSource.addFeature(searchAdrFeature);
            var searchAdrVectorLayer = new ol.layer.Vector({
                source: searchAdrVectorSource,
                style: iconStyle
            });
            window.searchAdrVectorLayer = searchAdrVectorLayer;
            map.addLayer(window.searchAdrVectorLayer);
        }
		
});




    var start = performance.now();
    proj4.defs("EPSG:3301", "+proj=lcc +lat_1=59.33333333333334 +lat_2=58 +lat_0=57.51755393055556 +lon_0=24 +x_0=500000 +y_0=6375000 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs");
    var projection = ol.proj.get('EPSG:3301');
	
	
	
	
	// create a style to display our position history (track)
      var trackStyle = new ol.style.Style({
        stroke: new ol.style.Stroke({
          color: 'rgba(0,0,255,1.0)',
          width: 15,
          lineCap: 'round'
        })
      });
      // use a single feature with a linestring geometry to display our track
      var trackFeature = new ol.Feature({
        geometry: new ol.geom.LineString([])
      });
      // we'll need a vector layer to render it
      var trackLayer = new ol.layer.Vector({
        source: new ol.source.Vector({
          features: [trackFeature]
        }),
        style: trackStyle
      });
	
	var view = new ol.View({
        center: [550000, 6520000],
        projection: projection
      });
    var map = new ol.Map({
        target: document.getElementById('map'),
		view: view
      
    });
    map.getView().setZoom(8);
    var wms = new ol.layer.Image({
        source: new ol.source.ImageWMS({
            url: 'http://kaart.maaamet.ee/wms/kaart?',
            params: {
                LAYERS: 'MA-KAART',
                VERSION: '1.1.1'
            }
        })
    });
    map.addLayer(wms);
	var ads_wmsSource = new ol.source.ImageWMS({
			url: 'http://kaart.maaamet.ee/wms/aadressid?',
			params: {
                LAYERS: 'MA-AADR',
                VERSION: '1.1.1'
            }
		});
	
	
	var ads_wms = new ol.layer.Image({
          source: ads_wmsSource
    });
    map.addLayer(ads_wms);
	
	
	map.on('singleclick', function(evt) {
	document.getElementById('infoBody').innerHTML = '';
			var viewResolution = (view.getResolution());
			
			var url = ads_wmsSource.getGetFeatureInfoUrl(
				evt.coordinate, viewResolution, 'EPSG:3301',
					{'INFO_FORMAT': 'text/plain'});
					url = url.replace("QUERY_LAYERS=MA-AADR", "QUERY_LAYERS=ads_cu,ads_hoone,ads_vk,ads_lp_punkt,ads_lp_joon,ads_aadr,eki_kohanimed,vi_kohanimed,asum,linnaosa,nimeobjekt_endine,nimeobjekt,adminkeskus");
					
					
				if (url) {
				$('#info').modal()
    document.getElementById('infoBody').innerHTML =
        '<iframe seamless src="' + url + '"></iframe>';
  }
});
	
	
	
	map.addLayer(trackLayer);
  
//set up the geolocation api to track our position
      var geolocation = new ol.Geolocation({
        tracking: true
      });
      // bind the view's projection
      geolocation.bindTo('projection', view);
      // when we get a position update, add the coordinate to the track's
      // geometry and recenter the view
      geolocation.on('change:position', function() {
        var coordinate = geolocation.getPosition();
        view.setCenter(coordinate);
        trackFeature.getGeometry().appendCoordinate(coordinate);
      });
      // put a marker at our current position
      var marker = new ol.Overlay({
        element: document.getElementById('location'),
        positioning: 'center-center'
      });
      map.addOverlay(marker);
      marker.bindTo('position', geolocation);
      // rotate the view to match the device orientation
      var deviceOrientation = new ol.DeviceOrientation({
        tracking: true
      });
      deviceOrientation.on('change:heading', onChangeHeading);
      function onChangeHeading(event) {
        var heading = event.target.getHeading();
        view.setRotation(-heading);
      }


	</script>
  </body>
</html>
