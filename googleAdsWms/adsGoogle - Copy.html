<!DOCTYPE html>
<html>

<head>
<meta charset="utf-8">
<title>ADS+GOOGLE</title>
<style>
html, body {
    height: 100%;
}

body {
    padding: 8px;
    background-color: #F6F6F6;
    box-sizing: border-box;
}

.split {
    -webkit-box-sizing: border-box;
    -moz-box-sizing: border-box;
    box-sizing: border-box;

    overflow-y: auto;
    overflow-x: hidden;
}

.content {
    border: 1px solid #C0C0C0;
    box-shadow: inset 0 1px 2px #e4e4e4;
    background-color: #fff;
}

.gutter {
    background-color: transparent;

    background-repeat: no-repeat;
    background-position: 50%;
}

.gutter.gutter-horizontal {
    cursor: col-resize;
    background-image: url('assets/img/grips/vertical.png');
}

.gutter.gutter-vertical {
    cursor: row-resize;
    background-image: url('assets/img/grips/horizontal.png');
}

.split.split-horizontal, .gutter.gutter-horizontal {
    height: 100%;
    float: left;
}

.inaadressSearchContainer {
    background: #fff;
    z-index: 1000;
}

.mainContainer {
    width: 100%;
    height: 80%;
}

.headerContainer {
    height: 20%;
    background: #fff;
}

#search {
    position: absolute;
    z-index: 1000;
    //margin-top: 20px;
    margin-left: 140px;
    width: 30%
}

#logo {
    font-size: 16px;
    padding: 14px 14px 14px 14px;
    color: #2779aa;
    cursor:pointer !important;
	
}

#date {
    right: 15px;
}

.ui-page-theme-a #search {
    background: #eee !important;
}

.change-map {
    top: 105px;
    left: .5em;
}

.ol-touch .change-map {
    top: 120px;
}

.rotate-north {
    top: 70px;
    left: .5em;
}

.ol-touch .rotate-north {
    top: 85px;
}

.modal fade {
    z-index: 99999999999999999999999;
}

.ol-control button {
    background-color: rgba(85, 150, 78, 0.5) !important;
    right: 8px;
    left: auto;
}

.modal {
    z-index: 999999 !important;
}

.ol-control.ol-zoom {

    left: -moz-calc(100% - 33px);
    left: -webkit-calc(100% - 33px);
    left: calc(100% - 33px);

}

#googleButtons {

}

#home {
    background: #fff url("http://xgis.maaamet.ee/dogisMaaamet/theme/maaamet/img/logo.png") no-repeat scroll 0 0;
}

.fa {
    margin-right: 10px;
}

.list-group .list-group-item:first-child {
    border-top-right-radius: 0;
    border-top-left-radius: 0;
}

.list-group .list-group-item {
    border-width: 0px 0;
}

.list-group {
    margin-bottom: 0;
}

.list-group-item {
    border-radius: 0;
}

.list-group .list-group {
    margin: 0;
    margin-top: 10px;
}

.list-group-item li.list-group-item {
    margin: 0 -15px;
    border-top: 0px solid #FFFFFF !important;
    border-bottom: 0;
    padding-left: 30px;
}

.list-group-item li.list-group-item:last-child {
    padding-bottom: 0;
}

div.list-group div.list-group {
    margin: 0;
}

div.list-group .list-group a.list-group-item {
    border-top: 0px solid #FFFFFF !important;
    border-bottom: 0;
    padding-left: 30px;
}

.list-group-item li.list-group-item {
    border-top: 0px solid #FFFFFF !important;
}

input[type="checkbox"], input[type="radio"] {
    margin-right: 10px !important;
}

.list-group {
    box-shadow: none !important;
}

.modal-backdrop {
    opacity: 0.1 !important;
}

a {
    text-decoration: none;
}

a:visited {
    text-decoration: none;
}

a:hover {
    text-decoration: none !important;
    cursor: default !important;
}

a:active {
    text-decoration: none;
}

ul.list-group li.list-group-item.clickable {
    cursor: pointer;
}



#infoButton {
    cursor: pointer;
}

#homeButton {
    cursor: pointer;
}
#homeButton2 {
    cursor: pointer;
}

#infoText:hover
{
  text-decoration:none !important;
  color:#337ab7;
}

ul.list-group.clickable li.list-group-item a {
    cursor: pointer !important;
}

ul.list-group li.list-group-item.clickable a {
    cursor: pointer !important;

}

#infoButton:hover {
    color: #337ab7;
}

#homeButton:hover {
    color: #337ab7;
}
#homeButton2:hover {
    color: #337ab7;
}


.verticalLineLeft {
    border-left: 1px solid #e5e5e5;
}

.verticalLineRight {
    border-right: 1px solid #e5e5e5;
}

#buttons {

    display: flex;
    flex-direction: column;
    justify-content: center;

}

#pano {

    height: 100%
}
#maLink {

cursor:pointer !important
}
.inAdsCopyright {
    line-height: 0px !important;
    margin: 0 !important;
    padding: 0 !important;
    visibility: hidden !important;
}

html body div#a.split.split-horizontal div.gutter.gutter-vertical {
    cursor: default !important;
    background-image: none !important
}



</style>
<link rel="stylesheet" href="assets/css/normalize.css">
<link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css">
<link rel="stylesheet" href="assets/css/ol.css" type="text/css">
<script src="assets/js/ol.js" type="text/javascript"></script>
<link rel='shortcut icon' type='image/x-icon' href='assets/img/favicon.ico'/>
<link rel="stylesheet" href="assets/css/bootstrap.min.css">
<link rel="stylesheet" href="assets/css/bootstrap-theme.min.css">
<script type="text/javascript" src="assets/js/jquery-2.1.4.min.js"></script>
<script src="assets/js/bootstrap.min.js"></script>
<script type="text/javascript" src="http://inaadress.maaamet.ee/inaadress/js/inaadress.min.js"></script>
<script type="text/javascript" src="assets/js/proj4.js"></script>
<script type="text/javascript" src="assets/js/3301.js"></script>
<script src="assets/js/ResizeSensor.js"></script>
<script src="assets/js/split.min.js"></script>
<link href="http://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">


</head>

<body>


<div class="modal fade" id="layersModal">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">


                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
                        aria-hidden="true">&times;</span></button>
                <h4 class="modal-title">ADS+Google</h4>
            </div>
            <div class="modal-body">

                <ul class="nav nav-tabs nav-justified">
                    <li class="active"><a data-toggle="tab" href="#home">Kihid</a></li>
                    <li id="kihtideLegend"><a data-toggle="tab" href="#menu1">Kihtide legend</a></li>
                    <li><a data-toggle="tab" href="#menu2">Info</a></li>
                </ul>


                <div class="tab-content">
                    <div id="home" class="tab-pane fade in active">
                        <div class="row">
                            <div class="col-sm-6 verticalLineRight">
                                <ul class="list-group">
                                    <li class="list-group-item"><span class="fa fa-university text-primary"></span><a>
                                        &nbsp;&nbsp;&nbsp;&nbsp;Maa-amet</a>
                                        <ul class="list-group">
                                            <li class="list-group-item"><span
                                                    class="fa fa-camera text-danger"></span><a><input class="uus"
                                                                                                      type="checkbox">&nbsp;&nbsp;&nbsp;&nbsp;Töötlemata
                                                ortofotod</a></li>
											<li class="list-group-item"><span
                                                    class="fa fa-camera text-danger"></span><a><input class="ads"
                                                                                                      type="checkbox" checked>&nbsp;&nbsp;&nbsp;&nbsp;ADS hooned</a></li>

                                            <li class="list-group-item"><span
                                                    class="fa fa-picture-o text-success"></span><a><input class="photo"
                                                                                                          type="radio">&nbsp;&nbsp;&nbsp;&nbsp;Ortofoto</a>
                                            </li>

                                            <li class="list-group-item"><span
                                                    class="fa fa-picture-o text-success"></span><a><input class="hybrid"
                                                                                                          type="radio">&nbsp;&nbsp;&nbsp;&nbsp;Hübriidkaart</a>
                                            </li>

                                            <li class="list-group-item"><span class="fa fa-map-o text-danger"></span><a><input
                                                    class="base" type="radio">&nbsp;&nbsp;&nbsp;&nbsp;Baaskaart</a></li>
                                            <li class="list-group-item"><span
                                                    class="fa fa-picture-o text-warning"></span><a><input class="p6hi"
                                                                                                          type="radio">&nbsp;&nbsp;&nbsp;&nbsp;Põhikaart</a>
                                            </li>

                                        </ul>
                                    </li>
                                </ul>
                            </div>
                            <div class="col-sm-6">

                                <ul class="list-group">
                                    <li class="list-group-item"><span class="fa fa-google text-primary"></span><a>&nbsp;&nbsp;&nbsp;&nbsp;Google</a>
                                        <ul class="list-group">
                                            <li class="list-group-item"><span class="fa fa-map-o text-danger"></span><a><input
                                                    class="roadmapGoogle"
                                                    type="radio">&nbsp;&nbsp;&nbsp;&nbsp;Roadmap</a></li>

                                            <li class="list-group-item"><span
                                                    class="fa fa-picture-o text-success"></span><a><input
                                                    class="satelliteGoogle" type="radio">&nbsp;&nbsp;&nbsp;&nbsp;Satellite</a>
                                            </li>
                                            <li class="list-group-item"><span
                                                    class="fa fa-picture-o text-success"></span><a><input
                                                    class="hybridGoogle" type="radio">&nbsp;&nbsp;&nbsp;&nbsp;Hybrid</a>
                                            </li>

                                            <li class="list-group-item"><span
                                                    class="fa fa-picture-o text-warning"></span><a><input
                                                    class="terrainGoogle"
                                                    type="radio">&nbsp;&nbsp;&nbsp;&nbsp;Terrain</a></li>
                                        </ul>
                                    </li>
                                </ul>
                            </div>
                        </div>

                    </div>
                    <div id="menu1" class="tab-pane fade">

                        <ul class="list-group">
                            <li id="legendHybrid" class="list-group-item"><a>Hübriid</a> <br> <img
                                    src="http://xgis.maaamet.ee/maps/DoGis?dogis_link=getImage&image=HYBR.0.png"
                                    alt="Hübriid legend"></li>

                            <li id="legendOrtofoto" class="list-group-item"><a>Ortofoto - sellel kihil puudub legend</a></li>
                            <li id="legendBaas" class="list-group-item"><a>Kaart</a><br> <img
                                    src="http://xgis.maaamet.ee/maps/DoGis?dogis_link=getImage&image=NEW.2000000.png"
                                    alt="Hübriid legend"><br><a
                                    href="http://xgis.maaamet.ee/maps/DoGis?dogis_link=getImage&image=NEW.2000.png"
                                    target="_blank">Rohkem...</a></li>

                            <li id="legendPohi" class="list-group-item"><a>Põhikaart - sellel kihil puudub legend</a>
                            </li>
                        </ul>


                    </div>
                    <div id="menu2" class="tab-pane fade">
                        <br>

                        <div class="row">
                            <div class="col-sm-12 ">

    <span>Tegemist on rakendusega, mis kasutab aadressiotsingu Maa-ameti aadressiandmete süsteemi andmeid sisaldava 
	In-ADS rakendusliidese koos Google Maps rakendusliidese abil integreeritud Google Street View piltidega 
	ning OpenLayers 3 abil sünkroniseeritud Maa-ameti aluskaartidega.

 </span>
                                <ul class="list-group">
                                    <li class="list-group-item"><span class="fa fa-th"></span><a>&nbsp;&nbsp;&nbsp;&nbsp;
                                        Kasutatud tehnoloogiad:</a>
                                        <ul class="list-group clickable">
                                            <li class="list-group-item"><span class="fa fa-circle-o"></span><a
                                                    href="http://inaadress.maaamet.ee/inaadress/" target="_blank">&nbsp;&nbsp;&nbsp;&nbsp;In-ADS</a>
                                            </li>

                                            <li class="list-group-item"><span class="fa fa-circle-o"></span><a
                                                    href="http://openlayers.org/" target="_blank">&nbsp;&nbsp;&nbsp;&nbsp;OpenLayers
                                                3</a></li>
                                            <li class="list-group-item"><span class="fa fa-circle-o"></span><a
                                                    href="https://developers.google.com/maps/documentation/javascript/"
                                                    target="_blank">&nbsp;&nbsp;&nbsp;&nbsp;Google Maps JavaScript
                                                API</a></li>

                                        </ul>

                                    </li>
                                    <li class="list-group-item clickable"><span class="fa fa-envelope-o"></span><a
                                            href="mailto:ads.abi@maaamet.ee" target="_top">&nbsp;&nbsp;&nbsp;&nbsp;Lisainfot
                                        saab Maa-ameti aadressiandmete osakonnast.</a>
                                    </li>


                                </ul>


                            </div>
                        </div>

                    </div>
                </div>


            </div>

        </div>
        <!-- /.modal-content -->
    </div>
    <!-- /.modal-dialog -->
</div>
<!-- /.modal -->


<div id="search" style=" height: 400px"></div>

<div id="a" class="split split-horizontal">
    <div id="c" class="split content">
        <div id="menuArea" class="row">
            <div id="logo" class="col-sm-2"><a id="maLink" href="http://www.maaamet.ee" target="_blank"><img src="http://xgis.maaamet.ee/dogisMaaamet/theme/maaamet/img/logo.png"
                                                 style=" height: 70px" alt="maaamet"</img></a> </div>
            <div class="col-sm-7"></div>
            <div class="col-sm-2">
                <div id="kp">
					<a id="infoText">Street-View pildistamise kuupäev</a>
                    <div id="date"></div>
                </div>
            </div>

            <div id="buttons" class="col-sm-1 verticalLineLeft">


                <div class="horizontalLine"><i id="infoButton" class="material-icons">menu</i></div>
                <div><i id="homeButton" class="material-icons">&#xE1B3;</i></div>
				<div ><i id="homeButton2" class="material-icons" onclick="myFunction()">&#xE87A;</i></div>

            </div>

        </div>


    </div>
    <div id="ee" class="split content">
        <div id="pano"></div>
    </div>
</div>
<div id="b" class="split split-horizontal">
    <div id="wms" class="split content"></div>
    <div id="map" class="split content">

    </div>


</div>


<script>

/*window.onresize = function(event) {
 if($('body').width()<600){
 window.location.replace("adsGoogle_mobile2.html");

 }
 };*/

$(document).ready(function () {

	var menuHeight=$('#c').height();
	var infoHeight=$('#kp').height();
    $('#search').css('margin-top', (menuHeight/2-17.5)+'px');
    $('#logo').css('margin-top', (menuHeight/2-50)+'px');
    $('#kp').css('margin-top', (menuHeight/2-infoHeight/2)+'px');

    $('#c').css({
        'overflow': 'hidden'
    });


    var isMobile = {
        Android: function () {
            return navigator.userAgent.match(/Android/i);
        },
        BlackBerry: function () {
            return navigator.userAgent.match(/BlackBerry/i);
        },
        iOS: function () {
            return navigator.userAgent.match(/iPhone|iPad|iPod/i);
        },
        Opera: function () {
            return navigator.userAgent.match(/Opera Mini/i);
        },
        Windows: function () {
            return navigator.userAgent.match(/IEMobile/i) || navigator.userAgent.match(/WPDesktop/i);
        },
        any: function () {
            return (isMobile.Android() || isMobile.BlackBerry() || isMobile.iOS() || isMobile.Opera() || isMobile.Windows());
        }
    };
    //$("[rel=tooltip]").tooltip({ placement: 'right'});
    if (isMobile.any() || $('body').width() < 600) { //small window
        window.location.replace("adsGoogle_mobile.html");
    }
});


var zoomChanged = false;
var zoomChanged2 = false;

var homeLocation;
window.homeLocation = homeLocation


$("#infoButton").on("click", function () {
    $('#layersModal').modal()
});


/*SPLIT JS*/
Split(['#a', '#b'], {
    gutterSize: 8,
    sizes: [60, 40],
    cursor: 'col-resize',
    minSize: 150

})


Split(['#c', '#ee'], {
    direction: 'vertical',
    sizes: [15, 85],
    gutterSize: 8,
    cursor: 'row-resize',
    onDragStart: function (e) {
        throw "stop dragging"
    }
})

Split(['#wms', '#map'], {
    direction: 'vertical',
    sizes: [50, 50],
    gutterSize: 8,
    cursor: 'row-resize'
})


var searchAdrVectorSource = new ol.source.Vector({
});
window.searchAdrVectorSource = searchAdrVectorSource;
var markers = [];
function deleteMarker(map) {
    for (var i = 0; i < markers.length; i++) {
        markers[i].setMap(map);
    }
    markers = [];
}
$('#search').removeClass('ui-page-theme-a');
var proj1 = '+proj=lcc +lat_1=59.33333333333334 +lat_2=58 +lat_0=57.51755393055556 +lon_0=24 +x_0=500000 +y_0=6375000 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs',
        proj2 = '+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs ';
function initialize() {
    $('#search').removeClass('ui-page-theme-a');
    var sv = new google.maps.StreetViewService();
    window.sv = sv
    function processSVData(data, status) {
        if (status === google.maps.StreetViewStatus.OK) {
            var svwloc = data.location.latLng;
            var heading = google.maps.geometry.spherical.computeHeading(svwloc, coords);
            var marker = new google.maps.Marker({
                position: data.location.latLng,
                map: map,
                title: data.location.description,
                icon: 'http://maps.google.com/mapfiles/ms/icons/purple-dot.png'
            });
            markers.push(marker);
            panorama.setPano(data.location.pano);
            panorama.setPov({
                heading: heading,
                pitch: 0
            });
            panorama.setVisible(true);

            marker.addListener('click', function () {
                var markerPanoID = data.location.pano;
                panorama.setPano(markerPanoID);
                panorama.setPov({
                    heading: heading,
                    pitch: 0
                });
                panorama.setVisible(true);
            });
        } else {
            alert('Raadiuses 100 meetrit objekti asukohast StreetView andmestik puudub');
        }
    }
	    var maaamet = {
        lat: 59.421047261154946,
        lng: 24.697965935520642
    };
    sv.getPanoramaByLocation(maaamet, 100, function (data) {
        document.getElementById('date').innerHTML = data.imageDate;
		var menuHeight=$('#c').height();
					var infoHeight=$('#kp').height();
					$('#kp').css('margin-top', (menuHeight/2-infoHeight/2)+'px');
    });
    var map = new google.maps.Map(document.getElementById('map'), {
        center: maaamet,
        zoom: 17,
        maxZoom: 19,
        minZoom: 7,
        mapTypeControl: false,
        zoomControl: true
    });
    window.map = map;
    var element2 = document.getElementById('map');
    new ResizeSensor(element2, function () {
        google.maps.event.trigger(map, "resize");
    });


    map.addListener('idle', function () {
        var initZoom = map.getZoom()
        window.initZoom = initZoom;
    });



    var inAadress = new InAadress({
        "mode": "3",
        "container": "search",
        "nocss": false,
        "appartment": 0
    });
    window.inAadress = inAadress;
    document.addEventListener('addressSelected', function (e) {
        inAadress.hideResult();
        var aadress = e.detail[0].aadress;
        aadress = aadress.split(", ").reverse().join(", ");
        inAadress.setAddress(aadress);
    });
    document.addEventListener('addressSelected', function (e) {
        var info = e.detail;
        if (info.length > 0) {
            // usually select first coordinate as it is most precise
            var x = info[0].x;
            x = parseFloat(x);
            var y = info[0].y;
            y = parseFloat(y);
			

            var address = info[0].aadress;
            var coordinates = [y, x];
            wmsmap.getView().setCenter(coordinates);
            wmsmap.getView().setZoom(11);
            inAadress.setAddress(address);
            inAadress.hideResult();
            var searchAdrFeature = new ol.Feature({
                geometry: new ol.geom.Point([y, x]),
                name: address
            });
            var iconStyle = new ol.style.Style({
                image: new ol.style.Icon(({
                    anchor: [1, 1],
                    opacity: 1,
                    src: 'http://maps.google.com/mapfiles/ms/icons/red-dot.png'
                }))
            });
            //var searchAdrVectorSource = new ol.source.Vector({
            //});
            window.searchAdrVectorSource = searchAdrVectorSource;
            var startSourceSize = searchAdrVectorSource.getFeatures().length;
            for (var i = 0, ii = startSourceSize; i < ii; i++) {
                searchAdrVectorSource.removeFeature(searchAdrVectorSource.getFeatures()[0])
            }
            searchAdrVectorSource.addFeature(searchAdrFeature);
            var searchAdrVectorLayer = new ol.layer.Vector({
                source: searchAdrVectorSource,
                style: iconStyle
            });
            window.searchAdrVectorLayer = searchAdrVectorLayer;
            wmsmap.addLayer(window.searchAdrVectorLayer);


            var coords = new google.maps.LatLng(proj4(proj1, proj2, [y, x])[1], proj4(proj1, proj2, [y, x])[0]);
            window.coords = coords;
            map.setCenter(new google.maps.LatLng(proj4(proj1, proj2, [y, x])[1], proj4(proj1, proj2, [y, x])[0]));
            var marker = new google.maps.Marker({
                position: coords,
                icon: 'http://maps.google.com/mapfiles/ms/icons/red-dot.png'
            });
            //Add listener
            google.maps.event.addListener(marker, "click", function (event) {
                var latitude = event.latLng.lat();
                var longitude = event.latLng.lng();
            }); //end addListener
            marker.setMap(map);
            deleteMarker(null);
            markers.push(marker);
            sv.getPanorama({
                location: coords,
                radius: 100
            }, processSVData);
            if (typeof coords !== "undefined") {
                sv.getPanoramaByLocation(coords, 100, function (data) {
                    document.getElementById('date').innerHTML = data.imageDate;
					
                });
            } else {
            }
			  wmsmap.getView().setCenter(coordinates);
			   map.setCenter(new google.maps.LatLng(proj4(proj1, proj2, [y, x])[1], proj4(proj1, proj2, [y, x])[0]));
			  wmsmap.getView().setCenter(coordinates);
			
			
        }
    })

	
	

    /*Google events */

    map.addListener('zoom_changed', function () {
        if (zoomChanged2 == false) {
            zoomChanged2 = true;
            var zoomLevel = map.getZoom();
            var wmsZoom = wmsmap.getView().getZoom();
            if (initZoom < zoomLevel) {
                var newWmsZoom = wmsZoom + 1;
                wmsmap.getView().setZoom(newWmsZoom);
                wmsInitZoom = newWmsZoom

            } else {
                var newWmsZoom = wmsZoom - 1;
                wmsmap.getView().setZoom(newWmsZoom);
                wmsInitZoom = newWmsZoom

            }
            initZoom = zoomLevel;
        }

        else if (zoomChanged2 == true) {
            wmsInitZoom = wmsmap.getView().getZoom();
            initZoom = map.getZoom();
            zoomChanged2 = false;
        }

    });
    map.addListener('center_changed', function () {
        if (zoomChanged == false) {
            var coordC = map.getCenter();
            var lest = proj4(proj2, proj1, [coordC.lng(), coordC.lat()]);
            wmsmap.getView().setCenter(lest);
            zoomChanged = true;
        }
        else if (zoomChanged == true) {
            zoomChanged = false
        }
    });


    var panorama = new google.maps.StreetViewPanorama(
            document.getElementById('pano'), {
                position: maaamet,
                mode: "html5",
                pov: {
                    heading: 113.51015984986623,
                    pitch: 10
                }
            });
    map.setStreetView(panorama);
    panorama.setOptions({
        addressControl: false
    });
    panorama.addListener('position_changed', function () {
        var coords = panorama.getPosition();
        sv.getPanoramaByLocation(coords, 100, function (data) {
            document.getElementById('date').innerHTML = data.imageDate;
        });
    });
    var element3 = document.getElementById('pano');
    new ResizeSensor(element3, function () {
        google.maps.event.trigger(panorama, "resize");
    });
	
	
		    streetView = map.getStreetView();

	/* google.maps.event.addListener(streetView, "pano_changed", function(){
        console.log(
            "pano_changed - " + this.getPosition());
			var pegman=this.getPosition();
			console.log(pegman)
			map.setCenter(pegman);
			/*var bounds=map.getBounds();
			if (bounds.contains(pegman)){
			}else{
						console.log("YO")
						        map.setCenter(pegman);

						

			}
    });*/
	

	
	
	
    google.maps.event.addListener(map, 'click', function (event) {
        var latitude = event.latLng.lat();
        var longitude = event.latLng.lng();
        var lest = proj4(proj2, proj1, [longitude, latitude]);
        var y = lest[0].toString();
        var x = lest[1].toString();
        x = parseFloat(x).toFixed(1);
        y = parseFloat(y).toFixed(1);

        var request = 'http://xgis.maaamet.ee/adsavalik/adsobjektid?x=' + x + '&y=' + y + '&ulatus=10&liik=CU';

        //  $.get(request, function(data) {
        //  alert("Load was performed.");
        //  });

        $.ajax({
            type: 'GET',
            url: request,
            async: false,
            jsonpCallback: 'jsonCallback',
            contentType: "application/json",
            dataType: 'jsonp',
            success: function (json) {
            },
            error: function (e) {
            }
        });


    });
    $('#search').removeClass('ui-page-theme-a');

	

	
    //Geolocation


    function savedGeolocation() {


        var coords = homeLocation;
        var lest = proj4(proj2, proj1, [coords.lng(), coords.lat()])
        var lestX = lest[0]
        var lestY = lest[1]

        wmsmap.getView().setCenter(lest);

        var searchAdrFeature = new ol.Feature({
            geometry: new ol.geom.Point([lestX, lestY])
        });
        var iconStyle = new ol.style.Style({
            image: new ol.style.Icon(({
                anchor: [1, 1],
                opacity: 1,
                src: 'http://maps.google.com/mapfiles/ms/icons/red-dot.png'
            }))
        });
        //var searchAdrVectorSource = new ol.source.Vector({
        //});
        window.searchAdrVectorSource = searchAdrVectorSource;
        var startSourceSize = searchAdrVectorSource.getFeatures().length;
        for (var i = 0, ii = startSourceSize; i < ii; i++) {
            searchAdrVectorSource.removeFeature(searchAdrVectorSource.getFeatures()[0])
        }
        searchAdrVectorSource.addFeature(searchAdrFeature);
        var searchAdrVectorLayer = new ol.layer.Vector({
            source: searchAdrVectorSource,
            style: iconStyle
        });
        window.searchAdrVectorLayer = searchAdrVectorLayer;
        wmsmap.addLayer(window.searchAdrVectorLayer);


        map.setCenter(coords);
        var marker = new google.maps.Marker({
            position: coords,
            icon: 'http://maps.google.com/mapfiles/ms/icons/red-dot.png'
        });
        //Add listener
        google.maps.event.addListener(marker, "click", function (event) {
            var latitude = event.latLng.lat();
            var longitude = event.latLng.lng();
        }); //end addListener


        marker.setMap(map);
        deleteMarker(null);
        markers.push(marker);
        sv.getPanorama({
            location: coords,
            radius: 100
        }, processSVData);
        if (typeof coords !== "undefined") {
            sv.getPanoramaByLocation(coords, 100, function (data) {
                document.getElementById('date').innerHTML = data.imageDate;
            });
        }
        ;


    }


    function startGeolocation() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(function (position) {
                var coords = new google.maps.LatLng(position.coords.latitude, position.coords.longitude);
                window.coords = coords;
                homeLocation = coords;

                var lest = proj4(proj2, proj1, [position.coords.longitude, position.coords.latitude])
                var lestX = lest[0]
                var lestY = lest[1]

                wmsmap.getView().setCenter(lest);

                var searchAdrFeature = new ol.Feature({
                    geometry: new ol.geom.Point([lestX, lestY])
                });
                var iconStyle = new ol.style.Style({
                    image: new ol.style.Icon(({
                        anchor: [1, 1],
                        opacity: 1,
                        src: 'http://maps.google.com/mapfiles/ms/icons/red-dot.png'
                    }))
                });
                //var searchAdrVectorSource = new ol.source.Vector({
                //});
                window.searchAdrVectorSource = searchAdrVectorSource;
                var startSourceSize = searchAdrVectorSource.getFeatures().length;
                for (var i = 0, ii = startSourceSize; i < ii; i++) {
                    searchAdrVectorSource.removeFeature(searchAdrVectorSource.getFeatures()[0])
                }
                searchAdrVectorSource.addFeature(searchAdrFeature);
                var searchAdrVectorLayer = new ol.layer.Vector({
                    source: searchAdrVectorSource,
                    style: iconStyle
                });
                window.searchAdrVectorLayer = searchAdrVectorLayer;
                wmsmap.addLayer(window.searchAdrVectorLayer);


                map.setCenter(new google.maps.LatLng(position.coords.latitude, position.coords.longitude));
                var marker = new google.maps.Marker({
                    position: coords,
                    icon: 'http://maps.google.com/mapfiles/ms/icons/red-dot.png'
                });
                //Add listener
                google.maps.event.addListener(marker, "click", function (event) {
                    var latitude = event.latLng.lat();
                    var longitude = event.latLng.lng();
                }); //end addListener


                marker.setMap(map);
                deleteMarker(null);
                markers.push(marker);
                sv.getPanorama({
                    location: coords,
                    radius: 100
                }, processSVData);
                if (typeof coords !== "undefined") {
                    sv.getPanoramaByLocation(coords, 100, function (data) {
                        document.getElementById('date').innerHTML = data.imageDate;
                    });
                }
                ;


            }, function () {

            });


        } else {
        }
    }

    $("#homeButton").click(function () {
        if (homeLocation == undefined) {
            startGeolocation()
        } else {
            savedGeolocation()
        }
    });

}


proj4.defs("EPSG:3301", "+proj=lcc +lat_1=59.33333333333334 +lat_2=58 +lat_0=57.51755393055556 +lon_0=24 +x_0=500000 +y_0=6375000 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs");
var projection = ol.proj.get('EPSG:3301');


var base = new ol.layer.Tile({
    source: new ol.source.TileWMS({
        attributions: [
            new ol.Attribution({
                html: '<a target="_blank" href="http://geoportaal.maaamet.ee/est/Teenused/Avalik-WMS-teenus-p65.html">Maa-amet</a>&nbsp;&nbsp;&nbsp;&nbsp;'
            })
        ],
        url: 'http://tiles.maaamet.ee/tm/s/?',
        tileGrid: new ol.tilegrid.TileGrid({
            origin: [40500, 5993000],
            resolutions: [4000.0, 2000.0, 1000.0, 500.0, 250.0, 125.0, 62.5, 31.25, 15.625, 7.8125, 3.90625, 1.953125, 0.9765625, 0.48828125]
        }),
        params: {
            LAYERS: 'kaart',
            TILED: true,
            VERSION: '1.0.0'
        }
    })
});
window.base = base;
p6hikaart = new ol.layer.Tile({
    maxResolution: 31.25,
    source: new ol.source.TileWMS({
        attributions: [
            new ol.Attribution({
                html: '<a target="_blank" href="http://geoportaal.maaamet.ee/est/Teenused/Avalik-WMS-teenus-p65.html">Maa-amet</a>&nbsp;&nbsp;&nbsp;&nbsp;'
            })
        ],
        url: 'http://tiles.maaamet.ee/tm/s/?',
        tileGrid: new ol.tilegrid.TileGrid({
            origin: [40500, 5993000],
            resolutions: [4000.0, 2000.0, 1000.0, 500.0, 250.0, 125.0, 62.5, 31.25, 15.625, 7.8125, 3.90625, 1.953125, 0.9765625, 0.48828125]
        }),
        params: {
            LAYERS: 'epk_v',
            TILED: true,
            VERSION: '1.0.0'
        }
    })
});
window.p6hikaart = p6hikaart;
var tile_hybrid = new ol.layer.Tile({
    title: "Maa-ameti hübriidkaart 2",
    maxResolution: 10000,
    source: new ol.source.TileWMS({
        url: 'http://tiles.maaamet.ee/tm/s/?',
        ratio: 1.05,
        tileGrid: new ol.tilegrid.TileGrid({
            origin: [40500, 5993000],
            resolutions: [4000.0, 2000.0, 1000.0, 500.0, 250.0, 125.0, 62.5, 31.25, 15.625, 7.8125, 3.90625, 1.953125, 0.9765625, 0.48828125]
        }),
        params: {
            TILED: true,
            LAYERS: ['hybriid'],
            FORMAT: 'image/png',
            TRANSPARENT: 'false',
            VERSION: '1.1.1'
        }
    })
});
window.tile_hybrid = tile_hybrid;
var tile_photo = new ol.layer.Tile({
    title: "Maa-ameti fotokaart",
    maxResolution: 10000,
    source: new ol.source.TileWMS({
        attributions: [
            new ol.Attribution({
                html: '<a target="_blank" href="http://geoportaal.maaamet.ee/est/Teenused/Avalik-WMS-teenus-p65.html">Maa-amet</a>&nbsp;&nbsp;&nbsp;&nbsp;'
            })
        ],
        url: 'http://tiles.maaamet.ee/tm/s/?',
        ratio: 1.05,
        tileGrid: new ol.tilegrid.TileGrid({
            origin: [40500, 5993000],
            resolutions: [4000.0, 2000.0, 1000.0, 500.0, 250.0, 125.0, 62.5, 31.25, 15.625, 7.8125, 3.90625, 1.953125, 0.9765625, 0.48828125]
        }),
        params: {
            LAYERS: ['foto'],
            FORMAT: 'image/jpeg',
            TRANSPARENT: 'false',
            VERSION: '1.1.1'
        }
    })
});
window.tile_photo = tile_photo;

var wmsNew = new ol.layer.Image({
    source: new ol.source.ImageWMS({
        url: 'http://www.maaamet.ee/rr/wms/of_live/?',
        params: {
            LAYERS: 'OF RGB korge foto,OF RGB madal foto',
            VERSION: '1.1.1'
        }
    })
});
window.wmsNew = wmsNew;

var wmsADS = new ol.layer.Image({
    source: new ol.source.ImageWMS({
        url: 'http://kaart.maaamet.ee/wms/aadressid?',
        params: {
            LAYERS:  'ads_hoone',
            VERSION: '1.1.1'
        }
    })
});
window.wmsADS = wmsADS;
var wmsADS2 = new ol.layer.Image({
    source: new ol.source.ImageWMS({
        url: 'http://kaart.maaamet.ee/wms/aadressid?',
        params: {
            LAYERS:  'ads_hoone_aadr',
            VERSION: '1.1.1'
        }
    })
});
window.wmsADS2 = wmsADS2;
var wmsADS3 = new ol.layer.Image({
    source: new ol.source.ImageWMS({
        url: 'http://kaart.maaamet.ee/wms/aadressid?',
        params: {
            LAYERS:  'ads_lp',
            VERSION: '1.1.1'
        }
    })
});
window.wmsADS3 = wmsADS3;

var wmsmap = new ol.Map({
    controls: ol.control.defaults({
        attributionOptions: /** @type {olx.control.AttributionOptions} */ ({
            collapsible: false
        })
    }),
    renderer: 'canvas',
    layers: [tile_photo, tile_hybrid, base, p6hikaart, wmsNew, wmsADS,wmsADS2,wmsADS3],
    target: document.getElementById('wms'),
    view: new ol.View({
        center: [539625, 6587225],
        resolutions: [500.0, 250.0, 125.0, 62.5, 31.25, 15.625, 7.8125, 3.90625, 1.953125, 0.9765625, 0.48828125, 0.244140625,0.1220703125, 0.06103515625],
        projection: projection
    })
});
wmsmap.getView().setZoom(10);

wmsNew.setVisible(false);
wmsADS.setVisible(true);
wmsADS2.setVisible(true);
wmsADS3.setVisible(true);

tile_photo.setVisible(true)
tile_hybrid.setVisible(false)
base.setVisible(false)
p6hikaart.setVisible(false)
$('.photo').prop('checked', true);
$('.roadmapGoogle').prop('checked', true);


/*OL events*/


var wmsInitZoom = wmsmap.getView().getZoom();
window.wmsInitZoom = wmsInitZoom;


$( ".ol-zoom-in" ).click(function() {
  if (wmsInitZoom==0){
	wmsmap.getView().setZoom(1)
  }
});


wmsmap.getView().on('change:resolution', function () {

	if(p6hikaart.getVisible()==true){
		if(wmsmap.getView().getZoom()<5){
			base.setVisible(true)} else {
			base.setVisible(false)
			}
	}
	
	
	
    if (zoomChanged2 == false) {
        zoomChanged2 = true

        var wmsZoom = wmsmap.getView().getZoom();
		console.log(wmsmap.getView().getZoom())
		if (wmsZoom==5){
			map.setZoom(12)
		}
		else if (wmsZoom==8){map.setZoom(15);
		}
		else if ( wmsZoom==1  ){
		console.log(1)
						map.setZoom(8)
		}
        else if (wmsInitZoom < wmsZoom) {
            var newGoogleZoom = initZoom + 1;
            map.setZoom(newGoogleZoom)
        }else if (wmsInitZoom==0&&wmsZoom==0) {
		
		}
		else {
            var newGoogleZoom = initZoom - 1;
            map.setZoom(newGoogleZoom)
        }
        wmsInitZoom = wmsmap.getView().getZoom();
        initZoom = map.getZoom()
    }

    else if (zoomChanged2 == true) {
        wmsInitZoom = wmsmap.getView().getZoom();
        initZoom = map.getZoom()

        zoomChanged2 = false
    }
});




wmsmap.on('pointerdrag', function (evt) {
    if (zoomChanged == false) {
        var coordsLest = wmsmap.getView().getCenter();
        var x = coordsLest[1];
        var y = coordsLest[0];
        map.setCenter(new google.maps.LatLng(proj4(proj1, proj2, [y, x])[1], proj4(proj1, proj2, [y, x])[0]));
        zoomChanged = true
    } else if (zoomChanged == true) {
        zoomChanged = false;
    }
});


/*LAYERS*/
var setNew = function (e) {
    if (wmsNew.getVisible()) {
        wmsNew.setVisible(false);
    } else {
        wmsNew.setVisible(true);
    }

};
var setADS = function (e) {
    if (wmsADS.getVisible()) {
        wmsADS.setVisible(false);
		wmsADS2.setVisible(false);
        wmsADS3.setVisible(false);

    } else {
        wmsADS.setVisible(true);
		wmsADS2.setVisible(true);
        wmsADS3.setVisible(true);
    }

};

var setPhoto = function (e) {
    tile_photo.setVisible(true)
    tile_hybrid.setVisible(false)
    base.setVisible(false)
    p6hikaart.setVisible(false)

};
var setHybrid = function (e) {
    tile_photo.setVisible(true)
    tile_hybrid.setVisible(true)
    base.setVisible(false)
    p6hikaart.setVisible(false)

};
var setBase = function (e) {
    tile_photo.setVisible(false)
    tile_hybrid.setVisible(false)
    base.setVisible(true)
    p6hikaart.setVisible(false)

    if (wmsmap.getView().getZoom() > 7) {
        wmsmap.getView().setZoom(5)
		//map.setZoom(12)
    }
};
var setP6hi = function (e) {
    tile_photo.setVisible(false)
    tile_hybrid.setVisible(false)
    base.setVisible(false)
    p6hikaart.setVisible(true)
	//map.setZoom(15)
    wmsmap.getView().setZoom(8);
};

$('input[type="radio"]').click(function () {
    if ($(this).is(':checked')) {
        var layerClass = $(this).attr('class')
        if (layerClass == "photo") {
            setPhoto();
            $('.hybrid').prop('checked', false);
            $('.base').prop('checked', false);
            $('.p6hi').prop('checked', false);

        } else if (layerClass == "hybrid") {
            setHybrid();
            $('.photo').prop('checked', false);
            $('.base').prop('checked', false);
            $('.p6hi').prop('checked', false);
        } else if (layerClass == "base") {

            setBase();
            $('.hybrid').prop('checked', false);
            $('.photo').prop('checked', false);
            $('.p6hi').prop('checked', false);
        } else if (layerClass == "p6hi") {

            setP6hi();
            $('.hybrid').prop('checked', false);
            $('.photo').prop('checked', false);
            $('.base').prop('checked', false);
        } else if (layerClass == "roadmapGoogle") {
            map.setMapTypeId(google.maps.MapTypeId.ROADMAP);
            $('.satelliteGoogle').prop('checked', false);
            $('.hybridGoogle').prop('checked', false);
            $('.terrainGoogle').prop('checked', false);
        } else if (layerClass == "satelliteGoogle") {
            map.setMapTypeId(google.maps.MapTypeId.SATELLITE);
            $('.roadmapGoogle').prop('checked', false);
            $('.hybridGoogle').prop('checked', false);
            $('.terrainGoogle').prop('checked', false);
        }
        else if (layerClass == "hybridGoogle") {
            map.setMapTypeId(google.maps.MapTypeId.HYBRID);
            $('.satelliteGoogle').prop('checked', false);
            $('.roadmapGoogle').prop('checked', false);
            $('.terrainGoogle').prop('checked', false);
        } else if (layerClass == "terrainGoogle") {
            map.setMapTypeId(google.maps.MapTypeId.TERRAIN);
            $('.satelliteGoogle').prop('checked', false);
            $('.hybridGoogle').prop('checked', false);
            $('.roadmapGoogle').prop('checked', false);
        }


    }
});
$('input[type="checkbox"]').click(function () {
 var layerClass = $(this).attr('class')
 console.log(layerClass)
         if (layerClass == "uus") {

    setNew();
	}else if (layerClass= "ads") {
	setADS();
	}
});


$(document).on("click", ".ui-input-clear", function () {
    if (typeof window.searchAdrVectorLayer === "object") {
        wmsmap.removeLayer(window.searchAdrVectorLayer);
        var startSourceSize = window.searchAdrVectorSource.getFeatures().length;
        for (var i = 0, ii = startSourceSize; i < ii; i++) {
            window.searchAdrVectorSource.removeFeature(window.searchAdrVectorSource.getFeatures()[0]);
        }
    }
    deleteMarker(null)
});


var element = document.getElementById('wms');
new ResizeSensor(element, function () {
    wmsmap.updateSize()
});

var menuArea = document.getElementById('c');
var initialMenuHeight = $('#c').height()
new ResizeSensor(menuArea, function () {
    var searchBarWidth = $('#search').width()
    var hideWidth = searchBarWidth + 120

    /*if ($('#c').height()>initialMenuHeight){
     $('#c').height(initialMenuHeight)
     }*/


    if ($('#c').width() < hideWidth) {
        $('#search').hide();
        $('#buttons').hide();
        $('#kp').hide();

    }
    else if ($('#c').width() > 682) {

        $('#search').show();
        $('#buttons').show();
        $('#kp').show();
    } else if ($('#c').width() < 682 && $('#c').width() > hideWidth) {
        $('#kp').hide();
        $('#buttons').hide();
        $('#search').show();
    }

});

$('#buttons').height($('#c').height())


$(document).on("click", "#kihtideLegend", function () {
    if (tile_hybrid.getVisible() == true) {
        $('#legendBaas').hide();
        $('#legendOrtofoto').hide();
        $('#legendHybrid').show();
        $('#legendPohi').hide();
    } else if (tile_photo.getVisible() == true && tile_hybrid.getVisible() == false) {
        $('#legendBaas').hide();
        $('#legendOrtofoto').show();
        $('#legendHybrid').hide();
        $('#legendPohi').hide();
    } else if (base.getVisible() == true) {
        $('#legendBaas').show();
        $('#legendOrtofoto').hide();
        $('#legendHybrid').hide();
        $('#legendPohi').hide();
    } else if (p6hikaart.getVisible() == true) {
        $('#legendBaas').hide();
        $('#legendOrtofoto').hide();
        $('#legendHybrid').hide();
        $('#legendPohi').show();
    }

});


	function myFunction() {
			console.log("function")
			var position=map.getStreetView().getPosition();
			var bingMapsX=position.lat();
			var bingMapsY=position.lng();
			var bingmapslink='http://www.bing.com/maps/default.aspx?cp='+bingMapsX+'~'+bingMapsY+'&style=o&lvl=19';
			 window.open(bingmapslink, '_blank'); 
	}
	




</script>
<script async defer
        src="https://maps.googleapis.com/maps/api/js??key=AIzaSyAcEJMfgaWuGbZ5AHNl5zwXOyDOd6tLhzw&callback=initialize">
</script>
</body>

</html>
