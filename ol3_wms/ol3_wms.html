<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title>WMS</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="http://openlayers.org/en/v3.2.1/css/ol.css" type="text/css">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css" integrity="sha512-dTfge/zgoMYpP7QbHy4gWMEGsbsdZeCXz7irItjcC3sPUFtf0kuFbDz/ixG7ArTxmDjLXDmezHubeNikyKGVyQ==" crossorigin="anonymous">
    <script src="http://openlayers.org/en/v3.2.1/build/ol.js" type="text/javascript"></script>
    <script type="text/javascript" src="http://inaadress.maaamet.ee/inaadress/js/inaadress.min.js"></script>
    <script type="text/javascript" src="proj4.js"></script>
    <script type="text/javascript" src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js" integrity="sha512-K1qjQ+NcF2TYO/eI3M6v8EiNYZfA95pQumfvcVrTHtwQVDG+aHRqLi/ETn2uB+1JqwYqVG3LIvdm9lj6imS/pQ==" crossorigin="anonymous"></script>
    <style>
.change-map {
  top: 105px;
  left: .5em;
}
.ol-touch .change-map {
  top: 120px;
}
.rotate-north {
  top: 70px;
  left: .5em;
}
.ol-touch .rotate-north {
  top: 85px;
}

</style>
</head>
<body>
<div id="map"></div>
 <div class='col-md-4' id="adr"></div>

<div class="modal fade" id="infoModal">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title">WMS kihid</h4>
      </div>
      <div class="modal-body">
        <ul>
         <li>! - töötlemata ortofotod</li>
         <li>O - ortofoto</li>
         <li>H - hübriidkaart</li>
         <li>B - baaskaart</li>
         <li>P - põhikaart</li>
        </ul>

      </div>
      <div class="modal-footer">

      </div>
    </div><!-- /.modal-content -->
  </div><!-- /.modal-dialog -->
</div><!-- /.modal -->


<script>

window.app = {};
var app = window.app;
app.ChangeMapControl = function(opt_options) {
  var options = opt_options || {};

  var this_ = this;
  var setNew = function(e) {
    if(wmsNew.getVisible()){
      wmsNew.setVisible(false);
    }else{
      wmsNew.setVisible(true);
    }

  };
  var setPhoto = function(e) {
  tile_photo.setVisible(true)
  tile_hybrid.setVisible(false)
  base.setVisible(false)
  p6hikaart.setVisible(false)

  };
  var setHybrid = function(e) {
  tile_photo.setVisible(true)
  tile_hybrid.setVisible(true)
  base.setVisible(false)
  p6hikaart.setVisible(false)

  };
  var setBase = function(e) {
		tile_photo.setVisible(false)
		tile_hybrid.setVisible(false)
		base.setVisible(true)
		p6hikaart.setVisible(false)

      if  ( this_.getMap().getView().getZoom()>7){
        this_.getMap().getView().setZoom(5)
      }
      };
  var setP6hi = function(e) {
		tile_photo.setVisible(false)
		tile_hybrid.setVisible(false)
		base.setVisible(false)
		p6hikaart.setVisible(true)
      this_.getMap().getView().setZoom(8)
  };


  var button_0 = document.createElement('button');
  button_0.className='uus';
  button_0.innerHTML = '!';

  var button_1 = document.createElement('button');
  button_1.className='photo';
  button_1.innerHTML = 'O';

  var button_2 = document.createElement('button');
  button_2.className='hybrid';
  button_2.innerHTML = 'H';

  var button_3 = document.createElement('button');
  button_3.className='base';
  button_3.innerHTML = 'B';

  var button_4 = document.createElement('button');
  button_4.className='p6hi';
  button_4.innerHTML = 'P';

  button_0.addEventListener('click', setNew, false);
  button_0.addEventListener('touchstart', setNew, false);

  button_1.addEventListener('click', setPhoto, false);
  button_1.addEventListener('touchstart', setPhoto, false);

  button_2.addEventListener('click', setHybrid, false);
  button_2.addEventListener('touchstart', setHybrid, false);

  button_3.addEventListener('click', setBase, false);
  button_3.addEventListener('touchstart', setBase, false);

  button_4.addEventListener('click', setP6hi, false);
  button_4.addEventListener('touchstart', setP6hi, false);



  var element = document.createElement('div');
  element.className = 'change-map ol-unselectable ol-control';
  element.appendChild(button_0);
  element.appendChild(button_1);
  element.appendChild(button_2);
  element.appendChild(button_3);
  element.appendChild(button_4);


  ol.control.Control.call(this, {
    element: element,
    target: options.target
  });

};
ol.inherits(app.ChangeMapControl, ol.control.Control);


app.RotateNorthControl = function(opt_options) {

  var options = opt_options || {};

  var button = document.createElement('button');
  button.innerHTML = '<i class="fa fa-info"></i>';

  var this_ = this;
  var handleRotateNorth = function(e) {
      $('#infoModal').modal()
     };

  button.addEventListener('click', handleRotateNorth, false);
  button.addEventListener('touchstart', handleRotateNorth, false);

  var element = document.createElement('div');
  element.className = 'rotate-north ol-unselectable ol-control';
  element.appendChild(button);

  ol.control.Control.call(this, {
    element: element,
    target: options.target
  });

};
ol.inherits(app.RotateNorthControl, ol.control.Control);

    var start = performance.now();
    proj4.defs("EPSG:3301", "+proj=lcc +lat_1=59.33333333333334 +lat_2=58 +lat_0=57.51755393055556 +lon_0=24 +x_0=500000 +y_0=6375000 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs");
    var projection = ol.proj.get('EPSG:3301');


    var base = new ol.layer.Tile({
        minResolution: 3.90625,
        source: new ol.source.TileWMS({
            attributions: [
                new ol.Attribution({
                    html: '<a target="_blank" href="http://geoportaal.maaamet.ee/est/Teenused/Avalik-WMS-teenus-p65.html">Basemaps Estonian Land Board</a>&nbsp;&nbsp;&nbsp;&nbsp;'
                })
            ],
            url: 'http://tiles.maaamet.ee/tm/s/?',
            tileGrid: new ol.tilegrid.TileGrid({
                origin: [40500, 5993000],
                resolutions: [4000.0, 2000.0, 1000.0, 500.0, 250.0, 125.0, 62.5, 31.25, 15.625, 7.8125, 3.90625, 1.953125, 0.9765625, 0.48828125]
            }),
            params: {
                LAYERS: 'kaart',
                TILED: true,
                VERSION: '1.0.0'
            }
        })
    });
    window.base = base;
    p6hikaart = new ol.layer.Tile({
        maxResolution: 3.90625,
        source: new ol.source.TileWMS({
            attributions: [
                new ol.Attribution({
                    html: '<a target="_blank" href="http://geoportaal.maaamet.ee/est/Teenused/Avalik-WMS-teenus-p65.html">Basemaps Estonian Land Board</a>&nbsp;&nbsp;&nbsp;&nbsp;'
                })
            ],
            url: 'http://tiles.maaamet.ee/tm/s/?',
            tileGrid: new ol.tilegrid.TileGrid({
                origin: [40500, 5993000],
                resolutions: [4000.0, 2000.0, 1000.0, 500.0, 250.0, 125.0, 62.5, 31.25, 15.625, 7.8125, 3.90625, 1.953125, 0.9765625, 0.48828125]
            }),
            params: {
                LAYERS: 'epk_v',
                TILED: true,
                VERSION: '1.0.0'
            }
        })
    });
    window.p6hikaart = p6hikaart;
    var tile_hybrid = new ol.layer.Tile({
        title: "Maa-ameti hübriidkaart 2",
        maxResolution: 10000,
        source: new ol.source.TileWMS({
            url: 'http://tiles.maaamet.ee/tm/s/?',
            ratio: 1.05,
            tileGrid: new ol.tilegrid.TileGrid({
                origin: [40500, 5993000],
                resolutions: [4000.0, 2000.0, 1000.0, 500.0, 250.0, 125.0, 62.5, 31.25, 15.625, 7.8125, 3.90625, 1.953125, 0.9765625, 0.48828125]
            }),
            params: {
                TILED: true,
                LAYERS: ['hybriid'],
                FORMAT: 'image/png',
                TRANSPARENT: 'false',
                VERSION: '1.1.1'
            }
        })
    });
    window.tile_hybrid = tile_hybrid;
    var tile_photo = new ol.layer.Tile({
        title: "Maa-ameti fotokaart",
        maxResolution: 10000,
        source: new ol.source.TileWMS({
            attributions: [
                new ol.Attribution({
                    html: '<a target="_blank" href="http://geoportaal.maaamet.ee/est/Teenused/Avalik-WMS-teenus-p65.html">Basemaps Estonian Land Board</a>&nbsp;&nbsp;&nbsp;&nbsp;'
                })
            ],
            url: 'http://tiles.maaamet.ee/tm/s/?',
            ratio: 1.05,
            tileGrid: new ol.tilegrid.TileGrid({
                origin: [40500, 5993000],
                resolutions: [4000.0, 2000.0, 1000.0, 500.0, 250.0, 125.0, 62.5, 31.25, 15.625, 7.8125, 3.90625, 1.953125, 0.9765625, 0.48828125]
            }),
            params: {
                LAYERS: ['foto'],
                FORMAT: 'image/jpeg',
                TRANSPARENT: 'false',
                VERSION: '1.1.1'
            }
        })
    });
    window.tile_photo = tile_photo;

    var wmsNew = new ol.layer.Image({
        source: new ol.source.ImageWMS({
            url: 'http://www.maaamet.ee/rr/wms/of_live/?',
            params: {
                LAYERS: 'Maaamet OF Live',
                VERSION: '1.1.1'
            }
        })
    });
    window.wmsNew = wmsNew;



    var map = new ol.Map({
      controls: ol.control.defaults({
    attributionOptions: /** @type {olx.control.AttributionOptions} */ ({
      collapsible: false
    })
  }).extend([
    new app.ChangeMapControl(),
    new app.RotateNorthControl()
  ]),
  renderer: 'canvas',
    layers: [tile_photo, tile_hybrid, base, p6hikaart, wmsNew],
    target: document.getElementById('map'),
        view: new ol.View({
          center: [550000, 6520000],
                   resolutions: [500.0, 250.0, 125.0, 62.5, 31.25, 15.625, 7.8125, 3.90625, 1.953125, 0.9765625, 0.48828125],
          projection: projection
        })
    });
    map.getView().setZoom(8);
    wmsNew.setVisible(false);


    var inAadress = new InAadress({"mode": "3", "container": "adr", "nocss": false, "appartment": 0, lang: {search: "SEARCH", clear: "CLEAR"}});
        document.addEventListener('addressSelected', function (e) {
            if (typeof window.searchAdrVectorLayer === "object") {
                map.removeLayer(window.searchAdrVectorLayer);
            }
            var info = e.detail;
            if (info.length > 0) {
                // usually select first coordinate as it is most precise
                var x = info[0].x;
                x = parseFloat(x);
                var y = info[0].y;
                y = parseFloat(y);
                var address = info[0].aadress;
                var coordinates = [y, x];
                map.getView().setCenter(coordinates);
                map.getView().setZoom(11);
                inAadress.setAddress(address);
                inAadress.hideResult();
                var searchAdrFeature = new ol.Feature({
                    geometry: new ol.geom.Point([y, x]),
                    name: address
                });
                var iconStyle = new ol.style.Style({
                    image: new ol.style.Icon(({
                        anchor: [1, 1],
                        opacity: 1,
                        src: 'http://pegasus.ee/sites/all/modules/custom/mapblock/images/marker.png'
                    }))
                });
                var searchAdrVectorSource = new ol.source.Vector({
                });
                window.searchAdrVectorSource = searchAdrVectorSource;
                var startSourceSize = searchAdrVectorSource.getFeatures().length;
                for (var i = 0, ii = startSourceSize; i < ii; i++) {
                    searchAdrVectorSource.removeFeature(searchAdrVectorSource.getFeatures()[0])
                }
                searchAdrVectorSource.addFeature(searchAdrFeature);
                var searchAdrVectorLayer = new ol.layer.Vector({
                    source: searchAdrVectorSource,
                    style: iconStyle
                });
                window.searchAdrVectorLayer = searchAdrVectorLayer;
                map.addLayer(window.searchAdrVectorLayer);
            }
        });


        $(document).on("click", ".ui-input-clear", function () {
                if (typeof window.searchAdrVectorLayer === "object") {
                    map.removeLayer(window.searchAdrVectorLayer);
                    var startSourceSize = window.searchAdrVectorSource.getFeatures().length;
                    for (var i = 0, ii = startSourceSize; i < ii; i++) {
                        window.searchAdrVectorSource.removeFeature(window.searchAdrVectorSource.getFeatures()[0]);
                    }
                }
            });



map.getView().setZoom(0);

</script>
</body>
</html>
